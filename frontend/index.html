<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Email Client - Gmail & Outlook Integration</title>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Microsoft Authentication Library (Using jsDelivr CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.39.0/lib/msal-browser.min.js"></script>

  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <script>
    // Dynamic CSS for email client
    const style = document.createElement('style');
    style.innerHTML = `
      * { box-sizing: border-box; }
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: #f6f7fb;
        min-height: 100vh;
        margin: 0;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .main-flex {
        display: flex;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.08);
        max-width: 900px;
        width: 100%;
        min-height: 480px;
        overflow: hidden;
      }
      .left-section, .right-section {
        flex: 1 1 0;
        padding: 40px 32px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      .left-section {
        background: #f8fafc;
        border-right: 1px solid #e5e7eb;
      }
      .right-section {
        background: #fff;
      }
      .header {
        text-align: left;
        margin-bottom: 24px;
      }
      .header h1 {
        color: #222;
        font-size: 2rem;
        margin-bottom: 8px;
        font-weight: 700;
      }
      .header p {
        color: #666;
        font-size: 1rem;
        margin-bottom: 0;
      }
      .info-box {
        background: #e7f3ff;
        border-left: 4px solid #0078d4;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 30px;
        font-size: 13px;
        color: #0056b3;
        line-height: 1.6;
      }
      .login-section, .config-section {
        margin-bottom: 24px;
      }
      .login-section h2, .config-section h2 {
        color: #333;
        font-size: 1.1rem;
        margin-bottom: 12px;
        font-weight: 600;
        border-bottom: 1px solid #f0f0f0;
        padding-bottom: 6px;
      }
      .login-buttons {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 10px;
      }
      button {
        flex: 1;
        min-width: 160px;
        padding: 10px 16px;
        font-size: 15px;
        border: none;
        border-radius: 7px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-weight: 500;
        transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      #googleLoginBtn {
        background: #fff;
        color: #333;
        border: 2px solid #4285F4;
      }
      #googleLoginBtn:hover:not(:disabled) {
        background: #4285F4;
        color: #fff;
      }
      #microsoftLoginBtn {
        background: #fff;
        color: #333;
        border: 2px solid #0078d4;
      }
      #microsoftLoginBtn:hover:not(:disabled) {
        background: #0078d4;
        color: #fff;
      }
      .logout-btn {
        background: #dc3545;
        color: #fff;
        border: none;
        margin-top: 8px;
      }
      .logout-btn:hover {
        background: #c82333;
      }
      .output-section {
        margin-top: 10px;
      }
      .output-label {
        color: #666;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 6px;
        font-weight: 600;
      }
      pre {
        margin: 0;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 7px;
        word-break: break-all;
        white-space: pre-wrap;
        font-size: 12px;
        color: #333;
        border: 1px solid #e0e0e0;
        max-height: 120px;
        overflow-y: auto;
      }
      .status {
        margin-top: 8px;
        padding: 8px 12px;
        border-radius: 7px;
        font-size: 13px;
        font-weight: 500;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.pending {
        background: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
      }
      .icon { font-size: 18px; }
      @media (max-width: 900px) {
        .main-flex { flex-direction: column; min-height: unset; }
        .left-section, .right-section { padding: 24px 12px; }
      }
    `;
    document.head.appendChild(style);
  </script>
</head>
<body>

  <div class="main-flex">
    <div class="left-section">
      <div class="header">
        <h1>üìß Email OAuth Service</h1>
        <p>Secure login with Google or Microsoft</p>
      </div>
      <div class="info-box">
        <strong>‚ÑπÔ∏è Info:</strong> Please configure your OAuth credentials (Client IDs) below before using this service.
      </div>
      <div class="config-section">
        <h2>‚öôÔ∏è Configuration</h2>
        <div style="display: grid; gap: 15px;">
          <div>
            <label for="googleClientId" style="display: block; margin-bottom: 5px; color: #333; font-weight: 500; font-size: 14px;">
              Google Client ID:
            </label>
            <input 
              type="password" 
              id="googleClientId" 
              placeholder="Enter your Google Client ID" 
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: monospace;"
            />
          </div>
          <div>
            <label for="microsoftClientId" style="display: block; margin-bottom: 5px; color: #333; font-weight: 500; font-size: 14px;">
              Microsoft Client ID:
            </label>
            <input 
              type="password" 
              id="microsoftClientId" 
              placeholder="Enter your Microsoft Client ID" 
              style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-family: monospace;"
            />
          </div>
          <div style="display: flex; gap: 10px;">
            <button id="saveConfigBtn" style="flex: 1; background: #28a745; color: white; border: none;">
              <i class="fas fa-save icon"></i>
              <span>Save Credentials</span>
            </button>
            <button id="clearConfigBtn" style="flex: 1; background: #6c757d; color: white; border: none;">
              <i class="fas fa-trash icon"></i>
              <span>Clear</span>
            </button>
          </div>
          <div id="configStatus" class="status pending" style="text-align: center; display: none;">
            Configuration saved
          </div>
        </div>
      </div>
    </div>
    <div class="right-section">
      <div class="login-section">
        <h2>Google Gmail Login</h2>
        <div class="login-buttons">
          <button id="googleLoginBtn" disabled>
            <i class="fab fa-google icon"></i>
            <span>Login with Google</span>
          </button>
        </div>
        <div class="output-section">
          <div class="output-label">Access Token:</div>
          <div class="status pending" id="googleStatus">Not authenticated</div>
          <pre id="googleTokenOutput">Waiting for login...</pre>
        </div>
        <button class="logout-btn" id="googleLogoutBtn" style="display:none;">Logout from Google</button>
      </div>
      <div class="login-section">
        <h2>Microsoft Outlook Login</h2>
        <div class="login-buttons">
          <button id="microsoftLoginBtn">
            <i class="fab fa-microsoft icon"></i>
            <span>Login with Microsoft</span>
          </button>
        </div>
        <div class="output-section">
          <div class="output-label">Access Token:</div>
          <div class="status pending" id="microsoftStatus">Not authenticated</div>
          <pre id="microsoftTokenOutput">Waiting for login...</pre>
        </div>
        <button class="logout-btn" id="microsoftLogoutBtn" style="display:none;">Logout from Microsoft</button>
      </div>
    </div>
  </div>

  <script>
    /* ================= STORAGE UTILITIES ================= */
    const StorageManager = {
      getGoogleClientId: () => localStorage.getItem("google_client_id") || "",
      setGoogleClientId: (id) => localStorage.setItem("google_client_id", id),
      getMicrosoftClientId: () => localStorage.getItem("microsoft_client_id") || "",
      setMicrosoftClientId: (id) => localStorage.setItem("microsoft_client_id", id),
      clear: () => {
        localStorage.removeItem("google_client_id");
        localStorage.removeItem("microsoft_client_id");
      }
    };

    /* ================= CONFIGURATION UI ================= */
    document.getElementById("saveConfigBtn").onclick = () => {
      const googleId = document.getElementById("googleClientId").value.trim();
      const microsoftId = document.getElementById("microsoftClientId").value.trim();

      if (!googleId || !microsoftId) {
        showConfigStatus("Please enter both Client IDs", "error");
        return;
      }

      StorageManager.setGoogleClientId(googleId);
      StorageManager.setMicrosoftClientId(microsoftId);
      showConfigStatus("‚úì Credentials saved successfully", "success");
      
      // Reinitialize OAuth clients with new credentials
      setTimeout(() => {
        location.reload();
      }, 1500);
    };

    document.getElementById("clearConfigBtn").onclick = () => {
      if (confirm("Are you sure you want to clear all stored credentials?")) {
        StorageManager.clear();
        document.getElementById("googleClientId").value = "";
        document.getElementById("microsoftClientId").value = "";
        showConfigStatus("‚úì Credentials cleared", "success");
        
        // Reset authentication
        document.getElementById("googleTokenOutput").textContent = "Waiting for login...";
        document.getElementById("googleStatus").className = "status pending";
        document.getElementById("googleStatus").textContent = "Not authenticated";
        document.getElementById("googleLogoutBtn").style.display = "none";
        document.getElementById("microsoftTokenOutput").textContent = "Waiting for login...";
        document.getElementById("microsoftStatus").className = "status pending";
        document.getElementById("microsoftStatus").textContent = "Not authenticated";
        document.getElementById("microsoftLogoutBtn").style.display = "none";
      }
    };

    function showConfigStatus(message, type = "success") {
      const statusEl = document.getElementById("configStatus");
      statusEl.textContent = message;
      statusEl.className = "status " + type;
      statusEl.style.display = "block";
      
      if (type === "success") {
        setTimeout(() => {
          statusEl.style.display = "none";
        }, 3000);
      }
    }

    // Load stored credentials on page load
    function loadStoredCredentials() {
      const googleId = StorageManager.getGoogleClientId();
      const microsoftId = StorageManager.getMicrosoftClientId();
      
      if (googleId) document.getElementById("googleClientId").value = googleId;
      if (microsoftId) document.getElementById("microsoftClientId").value = microsoftId;
    }

    /* ================= GOOGLE ================= */
    let GOOGLE_CLIENT_ID = "";
    const GOOGLE_SCOPES = "https://www.googleapis.com/auth/gmail.readonly";
    let googleTokenClient = null;
    let googleAccessToken = null;

    window.onload = () => {
      loadStoredCredentials();

      GOOGLE_CLIENT_ID = StorageManager.getGoogleClientId();

      if (!GOOGLE_CLIENT_ID) {
        document.getElementById("googleLoginBtn").disabled = true;
        document.getElementById("googleStatus").textContent = "‚ìò Configure Client ID first";
        return;
      }

      try {
        googleTokenClient = google.accounts.oauth2.initTokenClient({
          client_id: GOOGLE_CLIENT_ID,
          scope: GOOGLE_SCOPES,
          callback: (response) => {
            if (response.access_token) {
              googleAccessToken = response.access_token;
              document.getElementById("googleTokenOutput").textContent = response.access_token;
              document.getElementById("googleStatus").className = "status success";
              document.getElementById("googleStatus").textContent = "‚úì Authenticated";
              document.getElementById("googleLogoutBtn").style.display = "block";
              // Store credentials for email-client
              storeCredentials("gmail", response.access_token);
            } else if (response.error) {
              document.getElementById("googleStatus").className = "status error";
              document.getElementById("googleStatus").textContent = "‚úó Error: " + response.error;
            }
          },
          error_callback: (error) => {
            document.getElementById("googleStatus").className = "status error";
            document.getElementById("googleStatus").textContent = "‚úó Error: " + error.type;
          }
        });
        document.getElementById("googleLoginBtn").disabled = false;
      } catch (error) {
        document.getElementById("googleStatus").className = "status error";
        document.getElementById("googleStatus").textContent = "‚úó Failed to initialize Google OAuth";
      }
    };

    document.getElementById("googleLoginBtn").onclick = () => {
      googleTokenClient.requestAccessToken();
    };

    document.getElementById("googleLogoutBtn").onclick = () => {
      googleAccessToken = null;
      document.getElementById("googleTokenOutput").textContent = "Waiting for login...";
      document.getElementById("googleStatus").className = "status pending";
      document.getElementById("googleStatus").textContent = "Not authenticated";
      document.getElementById("googleLogoutBtn").style.display = "none";
    };

    /* ================= MICROSOFT ================= */
    let MICROSOFT_CLIENT_ID = "";
    const MICROSOFT_REDIRECT_URI = "http://localhost:3000";

    let msalConfig = {
      auth: {
        clientId: "",
        authority: "https://login.microsoftonline.com/common",
        redirectUri: MICROSOFT_REDIRECT_URI,
      },
      cache: {
        cacheLocation: "localStorage"
      }
    };

    let msalInstance = null;

    // Initialize Microsoft MSAL after loading stored credentials
    document.addEventListener("DOMContentLoaded", () => {
      MICROSOFT_CLIENT_ID = StorageManager.getMicrosoftClientId();

      if (!MICROSOFT_CLIENT_ID) {
        document.getElementById("microsoftStatus").textContent = "‚ìò Configure Client ID first";
        return;
      }

      msalConfig.auth.clientId = MICROSOFT_CLIENT_ID;

      try {
        msalInstance = new msal.PublicClientApplication(msalConfig);
        msalInstance.initialize();
      } catch (error) {
        document.getElementById("microsoftStatus").className = "status error";
        document.getElementById("microsoftStatus").textContent = "‚úó Failed to initialize Microsoft OAuth";
      }
    });

    document.getElementById("microsoftLoginBtn").onclick = async () => {
      if (!msalInstance) {
        document.getElementById("microsoftStatus").className = "status error";
        document.getElementById("microsoftStatus").textContent = "‚úó Please configure Client ID first";
        return;
      }
      
      try {
        document.getElementById("microsoftStatus").className = "status pending";
        document.getElementById("microsoftStatus").textContent = "Authenticating...";
        
        const loginResponse = await msalInstance.loginPopup({
          scopes: ["Mail.Read"],
        });

        const tokenResponse = await msalInstance.acquireTokenSilent({
          scopes: ["Mail.Read"],
          account: loginResponse.account,
        });

        document.getElementById("microsoftTokenOutput").textContent = tokenResponse.accessToken;
        document.getElementById("microsoftStatus").className = "status success";
        document.getElementById("microsoftStatus").textContent = "‚úì Authenticated";
        document.getElementById("microsoftLogoutBtn").style.display = "block";
        // Store credentials for email-client
        storeCredentials("outlook", tokenResponse.accessToken);
      } catch (error) {
        document.getElementById("microsoftStatus").className = "status error";
        document.getElementById("microsoftStatus").textContent = "‚úó Authentication failed";
        console.error("Microsoft OAuth Error:", error);
      }
    };

    document.getElementById("microsoftLogoutBtn").onclick = async () => {
      if (!msalInstance) return;
      
      try {
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) {
          await msalInstance.logoutPopup({
            account: accounts[0]
          });
        }
        document.getElementById("microsoftTokenOutput").textContent = "Waiting for login...";
        document.getElementById("microsoftStatus").className = "status pending";
        document.getElementById("microsoftStatus").textContent = "Not authenticated";
        document.getElementById("microsoftLogoutBtn").style.display = "none";
      } catch (error) {
        console.error("Logout Error:", error);
      }
    };
  </script>

</body>
</html>
